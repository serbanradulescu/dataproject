---
title: "1. Title:Preliminary-results"
author: "2. Team members names: Maya Hachicha, Gabriel Olawuyi, Madhav Chandarana, Radulescu Serban"
date: "15/12/2020"
output: 
  html_document:
    code_folding: hide
---

```{r libraries and importat of data, include = FALSE, echo=TRUE}

source("01_import-data.R")
library(ggplot2)
library(agricolae)
library(stringr)
library(tidyverse)
library(survival)
library(survminer)
library(dplyr)
library(tidyr)
library(ggfortify)
library(factoextra)
library(cluster)
library(corrplot)
library(RVAideMemoire)
library(car)



```
![The studied insects and substance](data/collage1.png)
![The studied insects: hoverfly Eristalis tenax adult and larva](data/collage 2.png)




## 3. Introduction. Explain the origin and structure of your data.
Data comes from: https://peerj.com/articles/4258/, which is Effects of chronic exposure to thiamethoxam on larvae of the hoverfly Eristalis tenax (Diptera, Syrphidae).

The aquatic larvae of hoverfly were raised in lagoons with different concentrations of thiamethoxam. The paper studies the impact of the pesticide on larval development(weight gain), survival(whether the larva forms a pupa or not) , and seven adult behaviours.
Five-day old larvae were exposed to six concentrations of the pesticide measured in parts per billion(ppb) – 0, 5, 15, 50, 100, and 500. 
10 larval replicates per treatment
4 rounds of experiment
Total of 40 larvae were studied for each treatment. 

This resulted in 3 tables that we use as data frames: survival, behaviour, weight.

###   a.survival

 survival is a dataset with 6 column:
<br/> 1.the ID of repetition
<br/> 2.exp_round - different blocks, with 8 repetitions
<br/> 3.treatment - Control (0),T1=5, T2= 15, T3= 50, T4= 100, T5= 500 (quantity of substance applied)
<br/> 4.daysinxp  - the amount of days it needs to reach pupae and so to be considered
survived (5 days to time it forms a pupae)
<br/> 5.time to pup - if it never reached adulthood, daysinxp are considered 0
<br/> 6.dead - mortality (yes or no) 


---

###   b.behaviour

The behaviour data records the time spent by 7 day old adult hoverflies.
Seven adult behaviours were studied for 10 minutes (600 seconds) and
the time spent on each behaviour was recorded in seconds. 
The behaviours studied are - 
S- stationary
GR- grooming
W- walking
F- flying
PR- probing through the cage netting with their proboscis
N- feeding on nectar, pollen, and water
M- moving, which includes making small jerking motion while being stationary

<br/> 1.The blocks (1,2,3,4)
<br/> 2.Sample: a notation of the enclosed space it was studied
<br/> 3.Treatment: Control (0),T1=5, T2= 15, T3= 50, T4= 100, T5= 500 (quantity of substance applied)
<br/> 4.Sex of the insect
<br/> 5.6.7.8.9.10.11. the studied behaviours
<br/> 12.The time of study is identical for all insects: 10 minutes (600 seconds)

---

###  c.weight

<br/> 1.Rep = the block and the number of the repetition
<br/> 2.Treatment (explained before)
<br/> 3.Time (1 represents day 3, 2 day 6, 3 day 9, 4 day 12); the ones that died have measured only their last living weight
<br/> 4.FIL - Found in leaves: some insects escape and are found afterwards in the surroundings
<br/> 5.weight - in grams

---

## 4. Objectives and hypotheses.

In this project, the objectives will be to reproduce the analysis done by the team that conducted the study. Further analysis can be conducted, at the recommendation of the coordinating professor.

### OBJECTIVE TREATMENT ON SURVIVAL
Hypothesis 1:
H0: Treatments do not affect survival
H1: Treatments affect survival

Hypothesis 1': Redefine survival  and redo the analyses
H0': Treatments do not affect survival
H1': Treatments affect survival


### OBJECTIVE OF BEHAVIOUR STUDY
To study if the exposure to different concentrations of thiamethoxam during the larval stage affects the behaviour of hoverflies as adults.

Hypothesis 0: The amount of thiamethoxam hoverfly larvae are exposed to affects their behaviour as adults.
Hypothesis 1: The amount of thiamethoxam hoverfly larvae are exposed to does not affect their behaviour as adults.



### OBJECTIVE OF WEIGHT DATA
To analyse the response of larvae weights to different concentration of thiamethoxan 
Hypothesis:
H0: Larval weight does not depend upon the concentration of insecticide it is exposed to. 
H1: Larval weight depends upon the concentration of insecticide it is exposed to.




## 5. Methods. What have you done? And what did you use to do it? Step by step, so anyone could do it again by reading this part.

---

<span style="color: red;">Important note: you will find the code for the analysis like this:
<br/> survival - Task1Serban.R
<br/> weight - Task1Gabriel.R
<br/> behaviour - Task1Madhav.R and Task1Maya.R
</span>

--- 

### Methods for survival:

We plot the survival to study the effects of blocks and treatments. As we observe differences, we proceed to do a linear model  with the blocks as median. It confirms that Treatment 500 has an effect on survival. After that, we do a linear model to study the interaction between treatments and blocks. With a p_value = 0.3738 we conclude that no interaction can be proved. We proceed to find if there are any different effects of treatment on survival. 
Because the data is categorical, we use a fisher test. After a simple fisher test shows significant differences between treatments, we proceed with a multicomparison fisher test. It showed that treatment500 has significant differences with all of them, between the others there is no significant difference. 

The plot will also be ploted with Kaplan-Meier curves for a better visualisation.

Same results are obtained with the redefined survival. We redefine survival as the larvae that survived pupation and their behaviour could be studied as adults. Unfrtunately, we couldn't correlate each individual from surival with the ones form behaviour.

---

We also did an anova for the effect of treatment on the time to pupate. The effects of the blocks and the interaction between blocks and treatment was studied. No interaction (p = 0.27), we proceed with the anova. The anova has shown significantly different effects. Furthermore, a HSD test showed two types of effects: a and b.


### Methods for weight
Initial and final weight were made into different data frames. This was needed to find weight gain of the larvae. There is a difference in the number of rows between the newly created data frames, because some larvae escaped before the final weight and some immediately after the first weight, as a such, replicates having both the final and the initial weight were pulled to make a data frame. ANOVA and a Kruskal-Wallis test were used to check the effect of treatment on the larval weight.  Shapiro.test was used to check normality of data. 

### Metods for behaviour:

we sourced our data from the PeerJ article mentioned above. We did Principal Component Analysis to study the impact of thiamethoxam on adult behaviour.Other metods were too complex to be explained here, detailed with plots in results.

## 6. Results. Figures and tables with captions and description of what do they mean.

### a1. Effect of treatments on survival (multi-comp Fisher Test): 
#### treatment500 has significant differences with all of them, between the others there is no significant difference

```{r effect of treatments on survival, echo=TRUE}
#Step 1: We plot it in order to see if:
#-there are differences between the blocks
#-there are differences between the treatments

survival <- surv

survival$treatment <- as.factor(survival$treatment)
survival$exp_round <- as.factor(survival$exp_round)
ggplot(survival, aes(x=treatment, y=dead, fill=exp_round)) + 
  geom_bar(stat="identity")

#It is obvious that the treatment500 is different from the others.
#It is hard to observe if there are differences between blocks, we proced to do a linear model with the blocks as median

lm1 <- lm(dead ~ treatment + exp_round, data= survival)
#summary(lm1)

#P value is smaller than 0.05 for: treatment500. The other treatments and the blocks show a p_value smaller than 0.5 so no significant effect.
#We proceed to study the interaction betwenn treatments and blocks.

lm1 <- lm(dead ~ treatment + exp_round +
            I(as.numeric(treatment) * as.numeric(exp_round)),
          data= survival)
#summary(lm1)

#No interaction between treatments and blocks. (p_value = 0.3738)
#We proceed with the fisher test, as the data is categorical.

t1 <- table(survival$treatment, survival$dead)
#fisher.test(t1, simulate.p.value=TRUE)

#A simple fisher test tells us that there are significant differences between treatments.
#We proceed with a multi-comparation fisher test.
```

### Multi-comparation fisher test, each treatment compared with the control

```{r 2-effect of treatments on survival, echo=TRUE}
f1 <- fisher.multcomp(t1)
knitr::kable(f1$p.value[,1])

```
Treatment 500 has significant differences with the control, others show no significant difference (p value smaller than 0.05)


### a2. Effect of treatments on  REDEFINED survival (multi-comp Fisher Test): treatment500 has significant differences with all of them, between the others there is no significant difference

```{r effect of treatments on REDEFINED survival, error=FALSE, echo=TRUE}
#Redefine survival and redo the analyses

#Step 1:  Redefine dead
#We get the data from behaviour in order to redefine survival. In order to do this, we create survival2, a data frame with the insects that survived.

numextract <- function(string){
  str_extract(string, "\\-*\\d+\\.*\\d*")
}
behaviour <- beha
ID <- numextract(behaviour$sample)
survival2 <- data.frame(ID, behaviour$exp_round, behaviour$treatment)

names(survival2)[names(survival2) == "ID"] <- "RepID"
names(survival2)[names(survival2) == "behaviour.exp_round"] <- "exp_round"
names(survival2)[names(survival2) == "behaviour.treatment"] <- "treatment"

#Step 2: We observed that we can not corelate the data from behaviour with the one from survival, as the notations changed (we have sample 29 for exp_round 1)
#We find a work around: merge the data with the survival one, but deleting the days in exp and time to pupate, as those can not be corelated. We just keep the number of individuals that survived and the number of individual that were initially in the experience.

survival <- surv
survival[4:5] <- list(NULL)

redefdead <- replicate(213, 1)
survival <- data.frame(survival, redefdead)

i <- 1
j<- 1

for(i in 1:nrow(survival)){
  while(survival$treatment[i] == survival2$treatment[j] && 
        survival$exp_round[i] == survival2$exp_round[j] && j < nrow(survival2)){
    survival$redefdead[i] <- 0
    j<- j+1
    i <- i+1
  }}

#Step 1: We plot it in order to see if:
#-there are differences between the blocks
#-there are differences between the treatments


survival$treatment <- as.factor(survival$treatment)
survival$exp_round <- as.factor(survival$exp_round)
ggplot(survival, aes(x=treatment, y=redefdead, fill=exp_round)) + 
  geom_bar(stat="identity")

#It is obvious that the treatment500 is different from the others.
#It is hard to observe if there are differences between blocks, we proced to do a linear model with the blocks as median

lm1 <- lm(redefdead ~ treatment + exp_round, data= survival)
#summary(lm1)

#P value is smaller than 0.05 for: treatment500. The other treatments and the blocks show a p_value smaller than 0.5 so no significant effect.
#We proceed to study the interaction betwenn treatments and blocks.

lm1 <- lm(redefdead ~ treatment + exp_round +
            I(as.numeric(treatment) * as.numeric(exp_round)),
          data= survival)
#summary(lm1)

#No interaction between treatments and blocks. (p_value = 0.1551)
#We proceed with the fisher test, as the data is categorical.

t1 <- table(survival$treatment, survival$redefdead)
#fisher.test(t1, simulate.p.value=TRUE)

#A simple fisher test tells us that there are significant differences between treatments.
#We proceed with a multi-comparation fisher test.
```

### Multi-comparation fisher test, each treatment compared with the control

```{r 2-effect of treatments on REDEFINED survival, error=FALSE, echo=TRUE}
f1 <- fisher.multcomp(t1)
knitr::kable(f1$p.value[,1])


```
Treatment 500 has significant differences with the control, others show no significant difference (p value smaller than 0.05)


### a3. A plot that puts survival and pupate in perspective (Kaplan-Meier curves)

```{r Kaplan-Meier curves, error=FALSE, echo=TRUE}



survival <- surv

#we create the surv_object, which is a compiled version of the daysinexp and dead columns that can be interpreted using the survfit function
 
surv_object <- Surv(time = survival$daysinexp, event = survival$dead)

#Now we do the Kaplan-Meier curves
 
fit1 <- survfit(surv_object ~ treatment, data = survival)
#summary(fit1)
#We plot the Kaplan-Meier curves so we can see better
ggsurvplot(fit1, data = survival, pval = TRUE)


```



### b. Effect of treatments on time to pupate (ANOVA): Treatment 500 is the only one that shows significant differences #PLOT

```{r Effect of treatments on time to pupate (ANOVA), error=FALSE, echo=TRUE}

#Part 2 - Analysis on time to pupate on the original defined survival, as for the redefined we weren't able to identify the individuals

#Now we do the same with time to pupate. We found it already hard to read, because of the numerous treatments so we decided to include the time to pupate in another ggplot.
surv_object <- Surv(time = survival$timetopup, event = survival$dead)
fit2 <- survfit(surv_object ~ treatment, data = survival)
#summary(fit2)
ggsurvplot(fit2, data = survival, main = "survival for pupate", pval = TRUE)

#As many insects die while on treatment 500, the plot for time to pupate isn't very conclusive.

#ANOVA

survival <- surv
#plot(y=survival$timetopup, x= survival$treatment, xlab="Time to pupate" , ylab="Treatment")

#We know from previous analysis that treatment 500 is different. We proceed to study the differences between blocks and treatments for the time to pupate

lm1 <- lm(timetopup ~ treatment + exp_round, data= survival)
#summary(lm1)

#P value is bigger than 0.05 for: treatment500. The other treatments and the blocks show a p_value smaller than 0.5 so no significant effect.
#We proceed to study the interaction betwenn treatments and blocks.

lm1 <- lm(timetopup ~ treatment + exp_round +
            I(as.numeric(treatment) * as.numeric(exp_round)),
          data= survival)
#summary(lm1)

#No interaction, p = 0.27, do the anova

anv <- aov( lm(survival$timetopup ~ survival$treatment) )
#summary(anv)

#Anova shows significant differences between treatments. We proceed with a HSD test.

agri <- HSD.test(anv, 'survival$treatment', alpha = 0.05, group=TRUE, main = "HSD Test")
plot(agri, main = "Observing statistical differences with agricola package", ylab = "Insects counted", xlab = "Type of spray", sub = "two groups of effects: a and b")

#Conclusions:
#Treatment 500 is the only one that shows significant differences in comparison with the control.


```

### c. Effects of treatments on behaviour


##### Step 1. Organizing the data. 
We had to convert our data from the tibble format to a numeric dataframe. 
```{r, error=FALSE}
behaviour1 <- beha  ## making a copy of the originaml dataframe
behaviour1 <- as.data.frame(behaviour1)
row.names(behaviour1) <- paste(behaviour1$sample,
                               behaviour1$exp_round, sep = "_")
b1 <-select(behaviour1, S:M)
b2 <- data.frame(as.factor(beha$treatment), b1)
colnames(b2)[colnames(b2) == "as.factor.beha.treatment."] <- "treatment"

```

##### Step 2.Analysis

We ran the prcomp command to run a PCA on our dataframe. 
```{r, error=FALSE}
pca1 <- prcomp(b1, scale = TRUE)

##Eigen values
eig.val <- get_eigenvalue(pca1)

##Scree plot
fviz_eig(pca1, addlabels = TRUE)
```
From the Eigen values and the Scree plot of our PCA we understand that Principal Component 1 and Principal Component 2 explain 46.4% of the variance in the data.

Heat mapping:
The heat map explains shows which behaviour is best explained by which Principal Component.
```{r, error=FALSE}


var <- get_pca_var(pca1)
var
head(var$coord)
head(var$cos2)
head(var$contrib)

autoplot(var$cor, main = "Heat map")
```
From the heat map we can visualize that the first two dimensions explain a largest degree of variance in our data. The third and fourth compnent also explain a large degree of the variance. The fourth dimension is a good fit for the probing behaviour (PR). 

correlation circle:
```{r, error=FALSE,warning=FALSE}
fviz_pca_var(pca1, col.var = "black")
```

This plot of the correlation circle visualizes the correlation between the first two principal components which explain the highest variance which are respectively 27.6 % and 18.8%. We can conclude that Flying and walking are correlated together (the arrow are grouped), stationary and 
grooming are correlated together and the arrow which reprents feeding on nectar, pollen, and water is in the opposite direction and not correlated with others behaviours.

Individuals PCA
```{r, error=FALSE,warning=FALSE}
autoplot(pca1, data = b2, colour = 'treatment', frame = TRUE, frame.type = 'norm')
```

This plot with ellipses shows the distribution of each behaviour following each treatment
From this plot we can conclude that there is no significant difference between the effect of treatment on different behaviours because the ellipses overlap



Weight
```{r, error=FALSE,warning=FALSE, echo=FALSE}
lavalweight <- weig
View(lavalweight)

### Make new data.frames from lavalweight for the initial and final time (1 & 4)
#for optimum analysis

Initialwgt <- filter(lavalweight, Time == 1)
Finalwgt <- filter(lavalweight, Time == 4)

###Find the difference between the final and initial weight. There is a difference
## in the number of row between the newly created data.frames, because some lavae
#escaped before the final weight and some immediately after the first weight, so 
#there is a need to get those reps that have both the final and the initial weight 
#to get the difference in weight.

Fordifference <- filter(lavalweight, Time == 4)


Initialweight <- replicate(153, 0)
Fordifference <- data.frame(Fordifference, Initialweight)

for(i in 1:nrow(Fordifference)){
  for(j in 1:nrow(Initialwgt)){
  if(Fordifference$Rep[i] == Initialwgt$Rep[j]){
    Fordifference$Initialweight[i] <- Initialwgt$weight[j]
  }}}

###Change the weight to final weight to differentiate between initial and final weight
colnames(Fordifference)[colnames(Fordifference) == "weight"] <- "Finalweight"

##Create another column for difference between final and initial weight
Fordifference$Difference <- (Fordifference$Finalweight - Fordifference$Initialweight)

##Remove the column time from the data.frame
Fordifference <-  select(Fordifference, -Time)

##Arrange the column of the data.frame in the order below
Fordifference <- Fordifference[c("Rep", "Treatment", "FIL", "Initialweight", 
                                 "Finalweight", "Difference")]

##Check the structure of newly created dataframes
str(Fordifference)

## The treatment, FIL and Time were integer, so i needed to convert them to a 
##factor for easier manipulation.
Fordifference$Treatment <- as.factor(Fordifference$Treatment)
Fordifference$FIL <- as.factor(Fordifference$FIL)

str(Fordifference)

#One-way ANOVA to determine the effect of thiamethoxam on weight
res.aov<- aov(Difference ~ Treatment, data = Fordifference)
summary(res.aov)

#Test for normality using the Shapiro–Wilk statistic.Making a Q-Q plot  
##This can only be done after ANOVA

shapiro.test(res.aov$residuals)
qqnorm(res.aov$residuals)
qqline(res.aov$residuals)

## Based on the shapiro.test, we can conclude that the distribution of the treatment
## effect was significantly different from normal distribution


##LeveneTest for equality of Variance
#Hypothesis
#H0: The variance for all groups are equal
#H1: At least one variance is not equal


leveneTest(Difference ~ Treatment, data = Fordifference)

#Based on the LeveneTest, the variance for all the groups are equal


#Kruskal Wallis to determine the effect of thiamethoxam on pupal weight

kruz <- kruskal(Fordifference$Difference, trt = Fordifference$Treatment)
print(kruz)

##Based on the Kruskal Wallis test, there is no significant difference between 
## treatments

##Make a plot for visual representation of the analysis
Fordifference %>%
  ggplot(aes(x = Treatment, group = Treatment, y = Difference, fill = Treatment)) +
  geom_violin(trim = FALSE) + 
  geom_boxplot(width = 0.2) +
  scale_y_continuous(limits = c(0.15, 0.50)) +
  theme_gray() +
  xlab("Treatment") + 
  ylab("Weight")
  

 ###Fisher's test
fil <- table(Fordifference$FIL, Fordifference$Treatment)
fil
fisher.test(fil)

 #p-value 0.3198 is greater than 0.05, therefore, 
##there is no sufficient evidence to accept the alternative hypothesis

```

## 7. Discussion. From your objectives.
Are to be done for the final presentation.

## 8. Conclusions.
We conclude that this project was hard but we learned a lot of stuff.

